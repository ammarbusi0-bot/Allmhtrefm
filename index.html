const allQuestions=[
{q:"من أول من أسلم من الرجال الأحرار؟",a:["أبو بكر الصديق","علي بن أبي طالب","عثمان بن عفان"],correct:0, info:"أبو بكر الصديق رضي الله عنه هو أول من أسلم من الرجال الأحرار."},
{q:"ما هي السورة التي تُسمى قلب القرآن؟",a:["يس","الرحمن","الكهف"],correct:0, info:"سورة يس تُسمى قلب القرآن لما ورد عن النبي ﷺ."},
{q:"كم عدد أركان الإسلام؟",a:["خمسة","ستة","سبعة"],correct:0, info:"أركان الإسلام خمسة: الشهادتان، الصلاة، الزكاة، الصوم، والحج."},
{q:"ما أول ما نزل من القرآن؟",a:["اقرأ باسم ربك","الفاتحة","المدثر"],correct:0, info:"أول ما نزل من القرآن الكريم هي الآيات الأولى من سورة العلق."},
{q:"ما اسم والدة النبي محمد ﷺ؟",a:["آمنة بنت وهب","خديجة بنت خويلد","حليمة السعدية"],correct:0, info:"والدة النبي ﷺ هي آمنة بنت وهب."},
{q:"كم عدد سور القرآن الكريم؟",a:["114","112","116"],correct:0, info:"يبلغ عدد سور القرآن الكريم 114 سورة."},
{q:"في أي عام كانت غزوة بدر الكبرى؟",a:["السنة الثانية للهجرة","الأولى للهجرة","الثالثة للهجرة"],correct:0, info:"وقعت غزوة بدر الكبرى في السنة الثانية للهجرة."},
{q:"من هو سيف الله المسلول؟",a:["خالد بن الوليد","حمزة بن عبد المطلب","أبو عبيدة بن الجراح"],correct:0, info:"خالد بن الوليد رضي الله عنه، لقبه النبي ﷺ بـ سيف الله المسلول."},
{q:"من النبي الذي ابتلعه الحوت؟",a:["يونس عليه السلام","إبراهيم عليه السلام","أيوب عليه السلام"],correct:0, info:"النبي يونس عليه السلام ابتلعه الحوت وبقي في بطنه فترة ثم نجاه الله."},
{q:"ما هي أطول سورة في القرآن الكريم؟",a:["البقرة","النساء","آل عمران"],correct:0, info:"أطول سورة في القرآن هي البقرة."}
];

// ** تم تعديل REFRESH_INTERVAL إلى 10 دقائق **
const QUIZ_LENGTH=10,REFRESH_INTERVAL=10*60*1000,TIME_PER_QUESTION=15;
const quizContainer=document.getElementById('quiz'),
      result=document.getElementById('result'),
      nextButton=document.getElementById('next-btn'),
      progressFill=document.getElementById('progress-fill'),
      timerElement=document.getElementById('timer'),
      timerValue=document.getElementById('timer-value'),
      timerNumber=document.getElementById('timer-number');

const soundCorrect=document.getElementById('sound-correct'),
      soundWrong=document.getElementById('sound-wrong'),
      soundNext=document.getElementById('sound-next'),
      soundTimeUp=document.getElementById('sound-timeup');

const backgroundMusic=document.getElementById('background-music'),
      musicToggleButton=document.getElementById('music-toggle-btn'),
      musicIcon=document.getElementById('music-icon'),
      musicStatus=document.getElementById('music-status');

let isMusicPlaying=false,selectedQuestions,currentQuestionIndex=0,score=0,answered=false,timerInterval,questionTimer,questionCountdown;

musicToggleButton.addEventListener('click',()=>{toggleMusic();});

function toggleMusic(){
    if(isMusicPlaying){backgroundMusic.pause();isMusicPlaying=false;musicIcon.textContent='🔇';musicStatus.textContent='تشغيل الموسيقى';}
    else{backgroundMusic.play().catch(()=>{});isMusicPlaying=true;musicIcon.textContent='🎵';musicStatus.textContent='إيقاف الموسيقى';}
}

function initializeQuestions(){
    // المنطق المضاف لاختيار مجموعة أسئلة ثابتة بناءً على الفترة الزمنية
    const now = Date.now();
    const intervalSeed = Math.floor(now / REFRESH_INTERVAL);
    
    // خوارزمية Fisher-Yates shuffle لخلط الأسئلة بـ "بذرة" ثابتة في كل فترة
    function seededShuffle(array, seed) {
        let currentIndex = array.length, temporaryValue, randomIndex;
        while (0 !== currentIndex) {
            randomIndex = (seed + currentIndex) % currentIndex;
            currentIndex -= 1;
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
        }
        return array;
    }

    // نسخ وخلط جميع الأسئلة ثم اختيار أول 10
    const shuffledQuestions = seededShuffle([...allQuestions], intervalSeed);
    selectedQuestions = shuffledQuestions.slice(0, QUIZ_LENGTH);
    
    currentQuestionIndex = 0;
    score = 0;
    result.classList.add('hidden');
    timerElement.classList.remove('hidden');
    startQuiz();
    updateRefreshTimer(now);
}

function startQuiz() {
    loadQuestion();
}

function loadQuestion() {
    // إيقاف أي مؤقت سابق وتفعيل زر التالي
    clearInterval(questionTimer);
    nextButton.classList.add('hidden');
    answered = false;
    
    if (currentQuestionIndex >= selectedQuestions.length) {
        showFinalResult();
        return;
    }

    const q = selectedQuestions[currentQuestionIndex];
    quizContainer.innerHTML = `
        <div class="question-card mt-6" style="opacity:1; transform:translateY(0);">
            <p class="text-xl md:text-2xl font-bold mb-6 text-yellow-100">السؤال ${currentQuestionIndex + 1} من ${QUIZ_LENGTH}</p>
            <h2 class="text-2xl md:text-3xl font-extrabold mb-8">${q.q}</h2>
            <div id="answers-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${q.a.map((answer, index) => `
                    <button class="answer-btn bg-teal-700 text-white p-3 rounded-xl shadow-lg hover:bg-teal-600" data-index="${index}">${answer}</button>
                `).join('')}
            </div>
            <div id="info-box" class="hidden text-sm mt-4"></div>
            <div class="timer-bar mt-6">
                <div id="timer-fill" class="timer-fill" style="transition:width ${TIME_PER_QUESTION}s linear;"></div>
            </div>
        </div>
    `;

    document.querySelectorAll('.answer-btn').forEach(btn => {
        btn.addEventListener('click', checkAnswer);
    });
    
    updateProgress();
    startQuestionTimer();
}

function startQuestionTimer() {
    let timeLeft = TIME_PER_QUESTION;
    const timerFill = document.getElementById('timer-fill');
    timerNumber.textContent = timeLeft;

    questionCountdown = timeLeft;

    timerFill.style.width = '100%';
    timerFill.style.transition = `width ${TIME_PER_QUESTION}s linear`;
    
    // إعادة تشغيل الأنميشن
    void timerFill.offsetWidth; 

    questionTimer = setInterval(() => {
        questionCountdown--;
        timerNumber.textContent = questionCountdown;
        if (questionCountdown <= 0) {
            clearInterval(questionTimer);
            handleTimeUp();
        }
    }, 1000);
}

function handleTimeUp() {
    if (!answered) {
        soundTimeUp.play().catch(()=>{});
        answered = true;
        const q = selectedQuestions[currentQuestionIndex];
        const answersContainer = document.getElementById('answers-container');
        answersContainer.classList.add('answered');
        
        // تظليل الإجابة الصحيحة
        document.querySelector(`.answer-btn[data-index="${q.correct}"]`).classList.add('correct');
        
        // عرض المعلومات
        const infoBox = document.getElementById('info-box');
        infoBox.textContent = q.info;
        infoBox.classList.remove('hidden');

        result.textContent = 'انتهى الوقت! ⏳ لم تحصل على نقطة.';
        result.className = 'mt-6 text-2xl md:text-3xl font-bold p-4 rounded-xl shadow-2xl bg-red-800 text-white';
        result.classList.remove('hidden');
        
        nextButton.classList.remove('hidden');
    }
}

function checkAnswer(event) {
    if (answered) return;
    answered = true;
    clearInterval(questionTimer);
    
    const selectedButton = event.target;
    const selectedIndex = parseInt(selectedButton.dataset.index);
    const q = selectedQuestions[currentQuestionIndex];
    const isCorrect = selectedIndex === q.correct;
    
    const answersContainer = document.getElementById('answers-container');
    answersContainer.classList.add('answered');
    
    // تظليل الإجابات
    document.querySelectorAll('.answer-btn').forEach(btn => {
        if (parseInt(btn.dataset.index) === q.correct) {
            btn.classList.add('correct');
        } else if (btn === selectedButton) {
            btn.classList.add('wrong');
        }
        btn.classList.add('answered');
    });
    
    // عرض المعلومات
    const infoBox = document.getElementById('info-box');
    infoBox.textContent = q.info;
    infoBox.classList.remove('hidden');

    if (isCorrect) {
        score++;
        soundCorrect.play().catch(()=>{});
        result.textContent = 'إجابة صحيحة! 🎉';
        result.className = 'mt-6 text-2xl md:text-3xl font-bold p-4 rounded-xl shadow-2xl bg-green-800 text-white';
    } else {
        soundWrong.play().catch(()=>{});
        result.textContent = 'إجابة خاطئة! 😔';
        result.className = 'mt-6 text-2xl md:text-3xl font-bold p-4 rounded-xl shadow-2xl bg-red-800 text-white';
    }
    
    result.classList.remove('hidden');
    nextButton.classList.remove('hidden');
}

function updateProgress() {
    const percentage = ((currentQuestionIndex) / QUIZ_LENGTH) * 100;
    progressFill.style.width = `${percentage}%`;
}

function showFinalResult() {
    progressFill.style.width = '100%';
    quizContainer.innerHTML = '';
    result.textContent = `انتهى الاختبار! 🎉 لقد حصلت على ${score} من ${QUIZ_LENGTH} نقاط.`;
    result.className = 'mt-6 text-3xl font-bold p-6 rounded-xl shadow-2xl bg-yellow-600 text-gray-900';
    result.classList.remove('hidden');
    nextButton.textContent = 'بدء اختبار جديد 🔄';
    nextButton.classList.remove('hidden');
    timerElement.classList.add('hidden');
}

function updateRefreshTimer(startTime) {
    const nextRefresh = startTime + REFRESH_INTERVAL;
    
    setInterval(() => {
        const now = Date.now();
        const remaining = nextRefresh - now;
        
        if (remaining <= 0) {
            // إعادة تحميل الصفحة للحصول على أسئلة جديدة
            location.reload(); 
            return;
        }

        const seconds = Math.floor((remaining / 1000) % 60);
        const minutes = Math.floor((remaining / 1000 / 60) % 60);
        
        timerValue.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

// معالج زر "السؤال التالي"
nextButton.addEventListener('click', () => {
    if (currentQuestionIndex >= selectedQuestions.length) {
        // إذا كان الزر يعرض "بدء اختبار جديد"
        initializeQuestions();
        nextButton.textContent = 'السؤال التالي ➡️';
    } else {
        soundNext.play().catch(()=>{});
        currentQuestionIndex++;
        result.classList.add('hidden');
        loadQuestion();
    }
});

// بدء التشغيل
initializeQuestions();
