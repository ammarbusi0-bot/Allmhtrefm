<script>
const allQuestions=[
{q:"من أول من أسلم من الرجال الأحرار؟",a:["أبو بكر الصديق","علي بن أبي طالب","عثمان بن عفان"],correct:0},
{q:"ما هي السورة التي تُسمى قلب القرآن؟",a:["يس","الرحمن","الكهف"],correct:0},
{q:"كم عدد أركان الإسلام؟",a:["خمسة","ستة","سبعة"],correct:0},
{q:"ما أول ما نزل من القرآن؟",a:["اقرأ باسم ربك","الفاتحة","المدثر"],correct:0},
{q:"ما اسم والدة النبي محمد ﷺ؟",a:["آمنة بنت وهب","خديجة بنت خويلد","حليمة السعدية"],correct:0},
{q:"كم عدد سور القرآن الكريم؟",a:["114","112","116"],correct:0},
{q:"في أي عام كانت غزوة بدر الكبرى؟",a:["السنة الثانية للهجرة","الأولى للهجرة","الثالثة للهجرة"],correct:0},
{q:"من هو سيف الله المسلول؟",a:["خالد بن الوليد","حمزة بن عبد المطلب","أبو عبيدة بن الجراح"],correct:0},
{q:"من النبي الذي ابتلعه الحوت؟",a:["يونس عليه السلام","إبراهيم عليه السلام","أيوب عليه السلام"],correct:0},
{q:"ما هي أطول سورة في القرآن الكريم؟",a:["البقرة","النساء","آل عمران"],correct:0}
];

const QUIZ_LENGTH=10,REFRESH_INTERVAL=12*60*60*1000;
const quizContainer=document.getElementById('quiz'),
      result=document.getElementById('result'),
      nextButton=document.getElementById('next-btn'),
      progressFill=document.getElementById('progress-fill'),
      timerElement=document.getElementById('timer'),
      timerValue=document.getElementById('timer-value'),
      startScreen=document.getElementById('start-screen'),
      startBtn=document.getElementById('start-btn');

let selectedQuestions,currentQuestionIndex=0,score=0,answered=false,timerInterval;

startBtn.addEventListener('click',()=>{
startScreen.classList.add('hidden');
document.querySelector('.progress-bar').classList.remove('hidden');
quizContainer.classList.remove('hidden');
initializeQuestions();
showQuestion();
});

function initializeQuestions(){
const now=Date.now();
const lastRefresh=parseInt(localStorage.getItem('lastRefresh')||'0');
let storedQuestions=localStorage.getItem('selectedQuestions');
const isQuizExpired=!lastRefresh||now-lastRefresh>REFRESH_INTERVAL;

if(isQuizExpired||!storedQuestions){
selectedQuestions=[...allQuestions].sort(()=>Math.random()-0.5).slice(0,QUIZ_LENGTH);
// ⚠️ يجب أيضاً خلط إجابات الأسئلة المخزنة في كل مرة لإزالة نمط الإجابة (correct: 0)
selectedQuestions = selectedQuestions.map(q => {
    const originalAnswers = q.a.map((text, i) => ({ text, isCorrect: i === q.correct }));
    const shuffledAnswers = originalAnswers.sort(() => Math.random() - 0.5);
    // نحدد مؤشر الإجابة الصحيحة الجديد في الترتيب الممزوج
    const newCorrectIndex = shuffledAnswers.findIndex(ans => ans.isCorrect);
    // إرجاع السؤال مع الإجابات الممزوجة والمؤشر الجديد
    return { q: q.q, a: shuffledAnswers.map(ans => ans.text), correct: newCorrectIndex, originalCorrectAnswer: q.a[q.correct] };
});

localStorage.setItem('selectedQuestions',JSON.stringify(selectedQuestions));
localStorage.setItem('lastRefresh',now);
localStorage.removeItem('currentQuestionIndex');
localStorage.removeItem('score');
currentQuestionIndex=0;score=0;
}else{
selectedQuestions=JSON.parse(storedQuestions);
currentQuestionIndex=parseInt(localStorage.getItem('currentQuestionIndex')||'0');
score=parseInt(localStorage.getItem('score')||'0');
if(currentQuestionIndex>=selectedQuestions.length){localStorage.removeItem('currentQuestionIndex');localStorage.removeItem('score');initializeQuestions();return;}
}
startTimer();
}

function startTimer(){
const lastRefresh=parseInt(localStorage.getItem('lastRefresh')||'0');
const endTime=lastRefresh+REFRESH_INTERVAL;
timerElement.classList.remove('hidden');
if(timerInterval) clearInterval(timerInterval);
timerInterval=setInterval(()=>{
const now=Date.now();
const remaining=endTime-now;
if(remaining<=0){clearInterval(timerInterval);timerValue.textContent="انتهى الوقت! (يتم التجديد الآن)";initializeQuestions();showQuestion();return;}
const totalSeconds=Math.floor(remaining/1000);
const hours=Math.floor(totalSeconds/3600);
const minutes=Math.floor((totalSeconds%3600)/60);
const seconds=totalSeconds%60;
timerValue.textContent=`${hours.toString().padStart(2,'0')} س و ${minutes.toString().padStart(2,'0')} د و ${seconds.toString().padStart(2,'0')} ث`;
},1000);
}

function showQuestion(){
if(currentQuestionIndex>=selectedQuestions.length){showResult();return;}
const q=selectedQuestions[currentQuestionIndex];
answered=false;
nextButton.classList.add('hidden');
progressFill.style.width=`${(currentQuestionIndex/selectedQuestions.length)*100}%`;

// ⚠️ لاحظ: الإجابات ممزوجة ومؤشر الإجابة الصحيحة مُحدث بالفعل في دالة initializeQuestions
// q.a يحتوي على الإجابات الممزوجة
// q.correct يحتوي على مؤشر الإجابة الصحيحة في هذا الترتيب الممزوج

quizContainer.innerHTML = `
    <div id="q-card" class="question-card p-6 md:p-8 mb-6">
        <p class="text-xl text-yellow-500 mb-4">سؤال ${currentQuestionIndex + 1} من ${selectedQuestions.length}</p>
        <h2 class="text-2xl md:text-3xl font-bold mb-6 md:mb-8">${q.q}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4" id="answers-container">
            ${q.a.map((ans,i)=>`
                <button data-index="${i}" onclick="checkAnswer(${i}, this)"
                        class="answer-btn w-full bg-emerald-700 text-white font-semibold py-3 px-4 rounded-xl shadow-md text-base md:text-lg hover:bg-emerald-600">
                    ${ans}
                </button>
            `).join('')}
        </div>
    </div>
`;
}

window.checkAnswer = function(selectedIndex, button){
if(answered) return;
answered=true;
const q = selectedQuestions[currentQuestionIndex];
const answerButtons = document.getElementById('answers-container').children;

Array.from(answerButtons).forEach(btn=>{
  const index=parseInt(btn.getAttribute('data-index'));
  // 💡 نستخدم q.correct الجديد (الممزوج) للمقارنة
  if(index===q.correct){btn.classList.add('correct');}
  else if(index===selectedIndex){btn.classList.add('wrong');}
  else{btn.classList.add('opacity-50');}
  btn.classList.add('answered');
});

// 💡 نستخدم قراءة الإجابة الصحيحة من الترتيب الحالي (الممزوج)
const correctAnswerText = q.a[q.correct];

if(selectedIndex===q.correct){
  score++;
  result.classList.remove('hidden');
  result.textContent="✅ إجابة صحيحة!";
  result.classList.remove('text-red-400','bg-red-900/50');
  result.classList.add('text-green-400','bg-green-900/50');
}
else{
  result.classList.remove('hidden');
  result.textContent="❌ إجابة خاطئة. الإجابة الصحيحة هي: " + correctAnswerText;
  result.classList.remove('text-green-400','bg-green-900/50');
  result.classList.add('text-red-400','bg-red-900/50');
}

nextButton.classList.remove('hidden');
localStorage.setItem('score',score);
}

window.nextQuestion=function(){
currentQuestionIndex++;
localStorage.setItem('currentQuestionIndex',currentQuestionIndex);
result.classList.add('hidden');
showQuestion();
}

function showResult(){
quizContainer.innerHTML='';
nextButton.classList.add('hidden');
result.classList.remove('hidden','bg-red-900/50','bg-green-900/50');
result.classList.add('text-yellow-300','bg-slate-800/80','p-6');
progressFill.style.width='100%';
const percentage=(score/selectedQuestions.length)*100;
let message='';
if(percentage===100) message="مبارك! 👑 الدرجة الكاملة! 💯";
else if(percentage>=70) message=`نتيجة ممتازة! ✨ ${score} من ${selectedQuestions.length}.`;
else if(percentage>=50) message=`نتيجة جيدة! 👍 ${score} من ${selectedQuestions.length}.`;
else message=`نتيجتك هي: ${score} من ${selectedQuestions.length}. تحتاج إلى مراجعة بسيطة. 📚`;
result.innerHTML=`<p class="text-3xl md:text-4xl mb-4">انتهى الاختبار!</p><p class="text-xl md:text-2xl font-bold mb-4">${message}</p><p class="text-lg mb-4">نسبة النجاح: ${percentage.toFixed(2)}%</p><button onclick="restartQuiz()" class="mt-4 bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded-full text-lg transition">ابدأ اختبار جديد</button>`;
localStorage.removeItem('currentQuestionIndex');
localStorage.removeItem('score');
if(timerInterval) clearInterval(timerInterval);
timerElement.classList.add('hidden');
}

window.restartQuiz=function(){
localStorage.removeItem('selectedQuestions');
localStorage.removeItem('lastRefresh');
initializeQuestions();
currentQuestionIndex=0;
score=0;
result.classList.add('hidden');
showQuestion();
}
</script>
</body>
</html>
